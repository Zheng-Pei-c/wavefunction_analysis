

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>wavefunction_analysis.spins.infinite_mps_block &mdash; wavefunction_analysis  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            wavefunction_analysis
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../wavefunction_analysis.html">wavefunction_analysis package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">wavefunction_analysis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">wavefunction_analysis.spins.infinite_mps_block</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for wavefunction_analysis.spins.infinite_mps_block</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wavefunction_analysis</span><span class="w"> </span><span class="kn">import</span> <span class="n">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wavefunction_analysis.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_matrix</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearOperator</span><span class="p">,</span> <span class="n">eigsh</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">linalg</span> <span class="k">as</span> <span class="n">LA</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">wavefunction_analysis.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">monitor_performance</span>

<span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">mu and nu indicate the left and right envrionment density matrices</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="contract_from_left">
<a class="viewcode-back" href="../../../wavefunction_analysis.spins.html#wavefunction_analysis.spins.infinite_mps_block.contract_from_left">[docs]</a>
<span class="nd">@monitor_performance</span>
<span class="k">def</span><span class="w"> </span><span class="nf">contract_from_left</span><span class="p">(</span><span class="n">mu_ba</span><span class="p">,</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">,</span> <span class="n">pick_eig</span><span class="o">=</span><span class="s1">&#39;LM&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    update the environment density matrix at left by contracting it</span>
<span class="sd">           with one more 2-sites (A and B) unit cell</span>
<span class="sd">    mu_ba: density matrix from the left connects A site via s_ba bond,</span>
<span class="sd">           bottom-up indexed</span>
<span class="sd">    mu_ab: also obtained from updated mu_ba and A site</span>
<span class="sd">    s_ab:  weight vector connects site A (left) to B (right)</span>
<span class="sd">    s_ba:  weight vector connects site B (left) to A (right)</span>
<span class="sd">    mps_a: MPS state at site A, bra at top</span>
<span class="sd">    mps_b: MPS state at site B, bra at top</span>
<span class="sd">           /-----2---s_{BA}---4---At---7---s_{AB}----9---Bt---12---</span>
<span class="sd">           |                      |                      |</span>
<span class="sd">         mu_{BA}                  5                      10</span>
<span class="sd">           |                      |                      |</span>
<span class="sd">          \\-----1---s_{BA}---6---Ab---3---s_{AB}---11---Bb----8---</span>
<span class="sd">    it is equivalent to</span>
<span class="sd">           /-----2---s_{BA}---4---A----7---s_{AB}---9---B----12---</span>
<span class="sd">           |                      |                     |</span>
<span class="sd">         mu_{BA}                  5                     10</span>
<span class="sd">           |                      |                     |</span>
<span class="sd">          \\-----1---s_{BA}---3---A*---6---s_{AB}---8---B*---11---</span>
<span class="sd">    we use the following summation as weigths are vectors (or diagonal)</span>
<span class="sd">           /-----2-j--s_{BA}---j---A---5-m---s_{AB}---m---B----8-p---</span>
<span class="sd">           |                       |                      |</span>
<span class="sd">         mu_{BA}                   3-k                    6-n</span>
<span class="sd">           |                       |                      |</span>
<span class="sd">          \\-----1-i--s_{BA}---i---A*--4-l---s_{AB}---l---B*---7-o---</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">chi_ba</span> <span class="o">=</span> <span class="n">mps_a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mu_ba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">chi_ba</span><span class="p">:</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="n">mu_ba</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># return an independent copy</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">chi_ba</span><span class="p">)</span><span class="o">/</span><span class="n">chi_ba</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="c1"># change in place</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">left_iter</span><span class="p">(</span><span class="n">mu_ba</span><span class="p">):</span>
        <span class="c1"># mu_ba would be iteratively solved from scipy eigs function</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,i,j,ikl,jkm,l,m,lno,mnp-&gt;op&#39;</span><span class="p">,</span>
                         <span class="n">mu_ba</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">chi_ba</span><span class="p">,</span><span class="n">chi_ba</span><span class="p">),</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span>
                         <span class="n">mps_a</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">mps_a</span><span class="p">,</span>
                         <span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">mps_b</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">mps_b</span><span class="p">,</span>
                         <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">d</span><span class="p">,</span> <span class="n">mu_ba</span> <span class="o">=</span> <span class="n">eigsh</span><span class="p">(</span><span class="n">LinearOperator</span><span class="p">((</span><span class="n">chi_ba</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">chi_ba</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">matvec</span><span class="o">=</span><span class="n">left_iter</span><span class="p">),</span>
                     <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="n">pick_eig</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="n">v0</span><span class="p">)</span>

    <span class="c1"># normalize the environment density matrix</span>
    <span class="n">mu_ba</span> <span class="o">=</span> <span class="n">mu_ba</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">chi_ba</span><span class="p">,</span> <span class="n">chi_ba</span><span class="p">)</span>
    <span class="n">mu_ba</span> <span class="o">=</span> <span class="n">mu_ba</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">mu_ba</span><span class="p">)</span>

    <span class="c1"># compute mu_ab density matrix</span>
    <span class="n">mu_ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,i,j,ikl,jkm-&gt;lm&#39;</span><span class="p">,</span>
                      <span class="n">mu_ba</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">mps_a</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mu_ab</span> <span class="o">=</span> <span class="n">mu_ab</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">mu_ab</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mu_ba</span><span class="p">,</span> <span class="n">mu_ab</span></div>



<div class="viewcode-block" id="contract_from_right">
<a class="viewcode-back" href="../../../wavefunction_analysis.spins.html#wavefunction_analysis.spins.infinite_mps_block.contract_from_right">[docs]</a>
<span class="nd">@monitor_performance</span>
<span class="k">def</span><span class="w"> </span><span class="nf">contract_from_right</span><span class="p">(</span><span class="n">nu_ab</span><span class="p">,</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">,</span> <span class="n">pick_eig</span><span class="o">=</span><span class="s1">&#39;LM&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    update the environment density matrix at right by contracting it</span>
<span class="sd">           with one more 2-sites (A and B) unit cell</span>
<span class="sd">    nu_ab: density matrix from the right connects A site via s_ab bond,</span>
<span class="sd">           top-down indexed</span>
<span class="sd">    nu_ba: also obtained from B site and updated nu_ab</span>
<span class="sd">    s_ab:  weight vector connects site A (left) to B (right)</span>
<span class="sd">    s_ba:  weight vector connects site B (left) to A (right)</span>
<span class="sd">    mps_a: MPS state at site A, bra at top</span>
<span class="sd">    mps_b: MPS state at site B, bra at top</span>
<span class="sd">            ----8---Bt---11---s_{BA}---3---At---6---s_{AB}---1----\\</span>
<span class="sd">                    |                      |                       |</span>
<span class="sd">                    10                     5                    nu_{AB}</span>
<span class="sd">                    |                      |                       |</span>
<span class="sd">            ---12---Bb----9---s_{BA}---7---Ab---4---s_{AB}---2-----/</span>
<span class="sd">    it is equivalent to</span>
<span class="sd">           ---11---BT----8---s_{BA}---6---AT----3---s_{AB}---1----\\</span>
<span class="sd">                   |                      |                        |</span>
<span class="sd">                   10                     5                     nu_{AB}</span>
<span class="sd">                   |                      |                        |</span>
<span class="sd">           ---12---B*T---9---s_{BA}---7---A*T---4---s_{AB}---2-----/</span>
<span class="sd">    we use the following summation as weigths are vectors (or diagonal)</span>
<span class="sd">        ---o-7---At---l---s_{BA}---l-4---At---i---s_{AB}---i-1----\\</span>
<span class="sd">                 |                       |                         |</span>
<span class="sd">                 6-n                     3-k                     nu_{AB}</span>
<span class="sd">                 |                       |                         |</span>
<span class="sd">        ---p-8---Ab---m---s_{BA}---m-5---Ab---j---s_{AB}---j-2-----/</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">chi_ab</span> <span class="o">=</span> <span class="n">mps_a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">nu_ab</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">chi_ab</span><span class="p">:</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="n">nu_ab</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># return an independent copy</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">chi_ab</span><span class="p">)</span><span class="o">/</span><span class="n">chi_ab</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="c1"># change in place</span>

    <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span> <span class="o">=</span> <span class="n">mps_a</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">mps_b</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">right_iter</span><span class="p">(</span><span class="n">mu_ba</span><span class="p">):</span>
        <span class="c1"># nu_ab would be iteratively solved from scipy eigs function</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,i,j,ikl,jkm,l,m,lno,mnp-&gt;op&#39;</span><span class="p">,</span>
                         <span class="n">nu_ab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">chi_ab</span><span class="p">,</span><span class="n">chi_ab</span><span class="p">),</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ab</span><span class="p">,</span>
                         <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_a</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span>
                         <span class="n">s_ba</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">,</span> <span class="n">mps_b</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span>
                         <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">d</span><span class="p">,</span> <span class="n">nu_ab</span> <span class="o">=</span> <span class="n">eigsh</span><span class="p">(</span><span class="n">LinearOperator</span><span class="p">((</span><span class="n">chi_ab</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">chi_ab</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">matvec</span><span class="o">=</span><span class="n">right_iter</span><span class="p">),</span>
                     <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="n">pick_eig</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="n">v0</span><span class="p">)</span>

    <span class="c1"># normalize the environment density matrix</span>
    <span class="n">nu_ab</span> <span class="o">=</span> <span class="n">nu_ab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">chi_ab</span><span class="p">,</span> <span class="n">chi_ab</span><span class="p">)</span>
    <span class="n">nu_ab</span> <span class="o">=</span> <span class="n">nu_ab</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">nu_ab</span><span class="p">)</span>

    <span class="c1"># compute nu_ba density matrix</span>
    <span class="n">nu_ba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,i,j,ikl,jkm-&gt;lm&#39;</span><span class="p">,</span>
                      <span class="n">nu_ab</span><span class="p">,</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_a</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">nu_ba</span> <span class="o">=</span> <span class="n">nu_ba</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">nu_ba</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nu_ab</span><span class="p">,</span> <span class="n">nu_ba</span></div>



<div class="viewcode-block" id="update_ortho_mps">
<a class="viewcode-back" href="../../../wavefunction_analysis.spins.html#wavefunction_analysis.spins.infinite_mps_block.update_ortho_mps">[docs]</a>
<span class="nd">@monitor_performance</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_ortho_mps</span><span class="p">(</span><span class="n">rho_left</span><span class="p">,</span> <span class="n">rho_right</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">mps_left</span><span class="p">,</span> <span class="n">mps_right</span><span class="p">,</span>
                     <span class="n">tol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    set the dimer AB or BA linker to cononical form</span>
<span class="sd">    update the weight connecting A and B sites and the MPSs</span>
<span class="sd">    the left and right rho and weight should have same order:</span>
<span class="sd">                    mu_ab, nu_ab, s_ab; or mu_ba, nu_ba, s_ba</span>
<span class="sd">            /-----s_{AB}----\\                    /-----s_{BA}----\\</span>
<span class="sd">            |                |                    |                |</span>
<span class="sd">          mu_{AB}^T        nu_{AB}      or      mu_{BA}          nu_{BA}^T</span>
<span class="sd">            |                |                    |                |</span>
<span class="sd">           \\-----s_{AB}-----/                   \\-----s_{BA}-----/</span>

<span class="sd">                           /---4-l---s_{AB}---l-4--\\</span>
<span class="sd">                           |                        |</span>
<span class="sd">    ---1-i---At---3-k--- mu_{AB}                  nu_{AB}---5-m---Bt---7-o---</span>
<span class="sd">           |                                                      |</span>
<span class="sd">           2-j                                                    6-n</span>
<span class="sd">           |                                                      |</span>
<span class="sd">    left rho is bottom-up indexed while right rho is top-down indexed</span>
<span class="sd">    first step: orthogonalize density matrices and form new weight</span>
<span class="sd">    second step: svd of new weight and construct new MPSs</span>
<span class="sd">    A * mu * s * \nu * B = A * l_U * (l_e * l_U^T * s * r_U * r_e) * r_U^T * B</span>
<span class="sd">                         = (A * l_U /l_e * U_s) * tilde{s} * (Vt_s /r_e * r_U^T * B)</span>
<span class="sd">    the third dimension of A and first dimension of B might be reduced</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">diag</span><span class="p">(</span><span class="n">rho</span><span class="p">):</span>
        <span class="n">e</span><span class="p">,</span> <span class="n">vec</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">e</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">)[</span><span class="mi">0</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># ordering from large to small</span>
        <span class="n">e</span><span class="p">,</span> <span class="n">vec</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">vec</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">vec</span>

    <span class="c1"># diagonalize environment density matrices</span>
    <span class="c1"># square-rooted eigenvalues</span>
    <span class="n">l_e</span><span class="p">,</span> <span class="n">l_vec</span> <span class="o">=</span> <span class="n">diag</span><span class="p">(</span><span class="n">rho_left</span><span class="p">)</span>
    <span class="n">r_e</span><span class="p">,</span> <span class="n">r_vec</span> <span class="o">=</span> <span class="n">diag</span><span class="p">(</span><span class="n">rho_right</span><span class="p">)</span>

    <span class="c1"># update weight matrix (s_ab or s_ba)</span>
    <span class="c1"># with sqrt(eigenvalues) of the density matrix</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,ji,j,jk,k-&gt;ik&#39;</span><span class="p">,</span> <span class="n">l_e</span><span class="p">,</span> <span class="n">l_vec</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">weight</span><span class="p">,</span>
                                          <span class="n">r_vec</span><span class="p">,</span> <span class="n">r_e</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vt</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="n">LA</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="c1"># update MPSs at A and B sites</span>
    <span class="n">mps_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk,kl,l,lm-&gt;ijm&#39;</span><span class="p">,</span> <span class="n">mps_left</span><span class="p">,</span> <span class="n">l_vec</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="n">l_e</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mps_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,j,kj,klm-&gt;ilm&#39;</span><span class="p">,</span> <span class="n">vt</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="n">r_e</span><span class="p">,</span> <span class="n">r_vec</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">mps_right</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">weight</span><span class="p">,</span> <span class="n">mps_left</span><span class="p">,</span> <span class="n">mps_right</span></div>



<div class="viewcode-block" id="normalize_mps">
<a class="viewcode-back" href="../../../wavefunction_analysis.spins.html#wavefunction_analysis.spins.infinite_mps_block.normalize_mps">[docs]</a>
<span class="nd">@monitor_performance</span>
<span class="k">def</span><span class="w"> </span><span class="nf">normalize_mps</span><span class="p">(</span><span class="n">s_left</span><span class="p">,</span> <span class="n">s_right</span><span class="p">,</span> <span class="n">mps</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    normalize the MPS at A or B site</span>
<span class="sd">        /---1---s_{BA}---2---At---5---s_{AB}---7--\\</span>
<span class="sd">        |                    |                     |</span>
<span class="sd">        1                    4                     7</span>
<span class="sd">        |                    |                     |</span>
<span class="sd">       \\---1---s_{BA}---6---Ab---3---s_{AB}---7---/</span>
<span class="sd">        since weight vectors are diagonal, it reduces to</span>
<span class="sd">        /---1---s_{BA}---1---A----3---s_{AB}---3--\\</span>
<span class="sd">        |                    |                     |</span>
<span class="sd">        1                    2                     3</span>
<span class="sd">        |                    |                     |</span>
<span class="sd">       \\---1---s_{BA}---1---A*---3---s_{AB}---3---/</span>
<span class="sd">    s_left and s_right are switched for site B</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s_left</span><span class="p">,</span> <span class="n">s_right</span> <span class="o">=</span> <span class="n">s_left</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">s_right</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,ijk,ijk,k-&gt;&#39;</span><span class="p">,</span> <span class="n">s_left</span><span class="p">,</span> <span class="n">mps</span><span class="p">,</span> <span class="n">mps</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">s_right</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mps</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span></div>



<div class="viewcode-block" id="normalize_mps_2">
<a class="viewcode-back" href="../../../wavefunction_analysis.spins.html#wavefunction_analysis.spins.infinite_mps_block.normalize_mps_2">[docs]</a>
<span class="nd">@monitor_performance</span>
<span class="k">def</span><span class="w"> </span><span class="nf">normalize_mps_2</span><span class="p">(</span><span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    normalize mps_a and mps_b at same time</span>
<span class="sd">    same functionality as the previous normalize_mps()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ba</span> <span class="o">=</span> <span class="n">s_ab</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">s_ba</span><span class="o">**</span><span class="mi">2</span>

    <span class="c1"># MPS_A norm</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,ijk,ijk,k-&gt;&#39;</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_a</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mps_a</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span>

    <span class="c1"># MPS_B norm</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,ijk,ijk,k-&gt;&#39;</span><span class="p">,</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">,</span> <span class="n">mps_b</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mps_b</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span></div>



<div class="viewcode-block" id="get_mps_2rdm">
<a class="viewcode-back" href="../../../wavefunction_analysis.spins.html#wavefunction_analysis.spins.infinite_mps_block.get_mps_2rdm">[docs]</a>
<span class="nd">@monitor_performance</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_mps_2rdm</span><span class="p">(</span><span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calculate the density matrix of the two-sites in a unit cell</span>
<span class="sd">    MPS is assumed in canoncial form (orthonormal)</span>
<span class="sd">    rho: ketbra{ket}{bra} = ketbra{Mb}{Mt} = ketbra{26}{37}</span>
<span class="sd">    rho_AB:</span>
<span class="sd">                           2-j                     6-n</span>
<span class="sd">                           |                       |</span>
<span class="sd">      /---1---s_{BA}---1---A*---4-l---s_{AB}---4---B*---8---s_{BA}---8---\</span>
<span class="sd">      |                                                                  |</span>
<span class="sd">      1-i                                                                8-p</span>
<span class="sd">      |                                                                  |</span>
<span class="sd">      /---1---s_{BA}---1---A----5-m---s_{AB}---5---B----8---s_{BA}---8---/</span>
<span class="sd">                           |                       |</span>
<span class="sd">                           3-k                     7-o</span>
<span class="sd">    rho_BA: switch A and B when calling the function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s_ab2</span><span class="p">,</span> <span class="n">s_ba2</span> <span class="o">=</span> <span class="n">s_ab</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">s_ba</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">rho_ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,ijl,ikm,l,m,lnp,mop,p-&gt;jnko&#39;</span><span class="p">,</span>
                       <span class="n">s_ba2</span><span class="p">,</span> <span class="n">mps_a</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ab</span><span class="p">,</span>
                       <span class="n">mps_b</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">mps_b</span><span class="p">,</span> <span class="n">s_ba2</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">rho_ba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,ijl,ikm,l,m,lnp,mop,p-&gt;jnko&#39;</span><span class="p">,</span>
                       <span class="n">s_ab2</span><span class="p">,</span> <span class="n">mps_b</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">mps_b</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span>
                       <span class="n">mps_a</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">s_ab2</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rho_ab</span><span class="p">,</span> <span class="n">rho_ba</span></div>



<div class="viewcode-block" id="evaluate_energy_mps">
<a class="viewcode-back" href="../../../wavefunction_analysis.spins.html#wavefunction_analysis.spins.infinite_mps_block.evaluate_energy_mps">[docs]</a>
<span class="nd">@monitor_performance</span>
<span class="k">def</span><span class="w"> </span><span class="nf">evaluate_energy_mps</span><span class="p">(</span><span class="n">mpo_ab</span><span class="p">,</span> <span class="n">mpo_ba</span><span class="p">,</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get energy of the two sites A and B</span>
<span class="sd">    use MPS and weights directly rather than build four-index density matrices</span>
<span class="sd">    E_AB:</span>
<span class="sd">      /---1---s_{BA}---1---A----4-l---s_{AB}---4---B----8---s_{BA}---8---\\</span>
<span class="sd">      |                    |                       |                     |</span>
<span class="sd">      |                   2-j--------\\   /--------6-n                    |</span>
<span class="sd">      |                              |   |                               |</span>
<span class="sd">      1-i                            H_{AB}                             8-p</span>
<span class="sd">      |                              |   |                               |</span>
<span class="sd">      |                   3-k--------/  \\--------7-o                    |</span>
<span class="sd">      |                    |                       |                     |</span>
<span class="sd">     \\---1---s_{BA}---1---A*---5-m---s_{AB}---5---B*---8---s_{BA}---8---/</span>
<span class="sd">    E_BA: switch A and B</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s_ab2</span><span class="p">,</span> <span class="n">s_ba2</span> <span class="o">=</span> <span class="n">s_ab</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">s_ba</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">e_ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,ijl,ikm,l,m,jnko,lnp,mop,p-&gt;&#39;</span><span class="p">,</span>
                     <span class="n">s_ba2</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_a</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">mpo_ab</span><span class="p">,</span>
                     <span class="n">mps_b</span><span class="p">,</span> <span class="n">mps_b</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">s_ba2</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">e_ba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,ijl,ikm,l,m,jnko,lnp,mop,p-&gt;&#39;</span><span class="p">,</span>
                     <span class="n">s_ab2</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">,</span> <span class="n">mps_b</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">mpo_ba</span><span class="p">,</span>
                     <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_a</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">s_ab2</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="mf">.5</span><span class="o">*</span><span class="p">(</span><span class="n">e_ab</span><span class="o">+</span><span class="n">e_ba</span><span class="p">)</span></div>



<div class="viewcode-block" id="evaluate_energy_rdm">
<a class="viewcode-back" href="../../../wavefunction_analysis.spins.html#wavefunction_analysis.spins.infinite_mps_block.evaluate_energy_rdm">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">evaluate_energy_rdm</span><span class="p">(</span><span class="n">mpo_ab</span><span class="p">,</span> <span class="n">mpo_ba</span><span class="p">,</span> <span class="n">rho_ab</span><span class="p">,</span> <span class="n">rho_ba</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    use the density matrix from get_mps_2rdm function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">e_ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnko,jnko-&gt;&#39;</span><span class="p">,</span> <span class="n">mpo_ab</span><span class="p">,</span> <span class="n">rho_ab</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">e_ba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnko,jnko-&gt;&#39;</span><span class="p">,</span> <span class="n">mpo_ba</span><span class="p">,</span> <span class="n">rho_ba</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="mf">.5</span><span class="o">*</span><span class="p">(</span><span class="n">e_ab</span><span class="o">+</span><span class="n">e_ba</span><span class="p">)</span></div>



<div class="viewcode-block" id="apply_gate_on_mps">
<a class="viewcode-back" href="../../../wavefunction_analysis.spins.html#wavefunction_analysis.spins.infinite_mps_block.apply_gate_on_mps">[docs]</a>
<span class="nd">@monitor_performance</span>
<span class="k">def</span><span class="w"> </span><span class="nf">apply_gate_on_mps</span><span class="p">(</span><span class="n">gate_ab</span><span class="p">,</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">,</span> <span class="n">chi</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    apply a gate from left to AB dimer MPSs (bra side) for time evolution</span>
<span class="sd">    use conjugate of evolution operator for the bra state</span>
<span class="sd">    gate_ab: e^{1j*t*ham_ab} for real-time or e^{-tau*ham_ab} for imaginary-time</span>
<span class="sd">        ---1---ss_{BA}---1---A---3---s_{AB}---3---B---5---ss_{BA}---5---</span>
<span class="sd">                             |                    |</span>
<span class="sd">                             2-------\\  /--------4</span>
<span class="sd">                                      |  |</span>
<span class="sd">                          -----6-----U_{AB}-----7-----</span>
<span class="sd">    above contraction gives a matrix whose indices in order 1675,</span>
<span class="sd">                            first and last are weight dimensions,</span>
<span class="sd">                            while the middle two are the physical dimensions</span>
<span class="sd">    subjected to svd to form new MPSs and weights s_ab</span>
<span class="sd">    gate_ba: switch A and B indices when calling this function</span>
<span class="sd">             so that update MPSs and s_ba</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ensure weights are above tolerance threshold</span>
    <span class="n">s_ba_trim</span> <span class="o">=</span> <span class="n">s_ba</span> <span class="o">*</span> <span class="p">(</span><span class="n">s_ba</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">)</span> <span class="o">+</span> <span class="n">tol</span> <span class="o">*</span> <span class="p">(</span><span class="n">s_ba</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>

    <span class="n">nd</span> <span class="o">=</span> <span class="n">mps_a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># real physical dimension, depending on spin type</span>
    <span class="n">chi_ba</span> <span class="o">=</span> <span class="n">s_ba_trim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,ijk,k,klm,m,jlno-&gt;inom&#39;</span><span class="p">,</span> <span class="n">s_ba_trim</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">,</span>
                    <span class="n">s_ba_trim</span><span class="p">,</span> <span class="n">gate_ab</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vt</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nd</span><span class="o">*</span><span class="n">chi_ba</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">chi</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span> <span class="c1"># truncate space!!! # s in descending order</span>
    <span class="n">s</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">vt</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">u</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">chi_ba</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">vt</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">chi_ba</span><span class="p">)</span>

    <span class="c1"># update weights</span>
    <span class="n">s_ab</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="n">LA</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="c1"># update MPSs removing environment weights</span>
    <span class="n">s_ba_trim</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">s_ba_trim</span>
    <span class="n">mps_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,ij-&gt;ij&#39;</span><span class="p">,</span> <span class="n">s_ba_trim</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">chi_ba</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mps_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,j-&gt;ij&#39;</span><span class="p">,</span> <span class="n">vt</span><span class="p">,</span> <span class="n">s_ba_trim</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">chi_ba</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span></div>



<div class="viewcode-block" id="build_evolution_gate">
<a class="viewcode-back" href="../../../wavefunction_analysis.spins.html#wavefunction_analysis.spins.infinite_mps_block.build_evolution_gate">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">build_evolution_gate</span><span class="p">(</span><span class="n">ham</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">itype</span><span class="o">=</span><span class="s1">&#39;imag&#39;</span><span class="p">):</span>
    <span class="c1"># ham has dimension as (d,d,d,d)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">expm</span>
    <span class="n">fac</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span> <span class="k">if</span> <span class="n">itype</span><span class="o">==</span><span class="s1">&#39;real&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mf">1.</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">ham</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">expm</span><span class="p">(</span><span class="n">fac</span><span class="o">*</span><span class="n">tau</span><span class="o">*</span><span class="n">ham</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">d</span><span class="p">)</span></div>



<div class="viewcode-block" id="run_tebd">
<a class="viewcode-back" href="../../../wavefunction_analysis.spins.html#wavefunction_analysis.spins.infinite_mps_block.run_tebd">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_tebd</span><span class="p">(</span><span class="n">ham_ab</span><span class="p">,</span> <span class="n">ham_ba</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">,</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span>
             <span class="n">mu_ba</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nu_ab</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">itype</span><span class="o">=</span><span class="s1">&#39;imag&#39;</span><span class="p">,</span>
             <span class="n">nmax</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">midstep</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    run time evolving block decimation based on MPS of infinite two-site unit cells</span>
<span class="sd">    refer: https://doi.org/10.1103/PhysRevLett.93.040502</span>
<span class="sd">           https://www.tensors.net/mps</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gate_ab</span> <span class="o">=</span> <span class="n">build_evolution_gate</span><span class="p">(</span><span class="n">ham_ab</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">itype</span><span class="o">=</span><span class="n">itype</span><span class="p">)</span>
    <span class="n">gate_ba</span> <span class="o">=</span> <span class="n">build_evolution_gate</span><span class="p">(</span><span class="n">ham_ba</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">itype</span><span class="o">=</span><span class="n">itype</span><span class="p">)</span>

    <span class="c1"># initialize envrionment density matrices</span>
    <span class="n">chi1</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">chi2</span> <span class="o">=</span> <span class="n">mps_a</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mu_ba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span> <span class="o">/</span> <span class="n">chi1</span>
    <span class="n">nu_ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span> <span class="o">/</span> <span class="n">chi2</span>

    <span class="n">e_tot</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">midstep</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="n">nmax</span><span class="p">):</span>
            <span class="c1"># bring MPS to the normal form</span>

            <span class="c1"># contract environment density, weights and MPSs</span>
            <span class="n">mu_ba</span><span class="p">,</span> <span class="n">mu_ab</span> <span class="o">=</span> <span class="n">contract_from_left</span><span class="p">(</span><span class="n">mu_ba</span><span class="p">,</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">)</span>
            <span class="n">nu_ab</span><span class="p">,</span> <span class="n">nu_ba</span> <span class="o">=</span> <span class="n">contract_from_right</span><span class="p">(</span><span class="n">nu_ab</span><span class="p">,</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">)</span>

            <span class="c1"># orthogonalize MPSs and weights</span>
            <span class="n">s_ba</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">,</span> <span class="n">mps_a</span> <span class="o">=</span> <span class="n">update_ortho_mps</span><span class="p">(</span><span class="n">mu_ba</span><span class="p">,</span> <span class="n">nu_ba</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">)</span>
            <span class="n">s_ab</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span> <span class="o">=</span> <span class="n">update_ortho_mps</span><span class="p">(</span><span class="n">mu_ab</span><span class="p">,</span> <span class="n">nu_ab</span><span class="p">,</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">)</span>

            <span class="c1"># normalize MPSs</span>
            <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span> <span class="o">=</span> <span class="n">normalize_mps_2</span><span class="p">(</span><span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">)</span>

            <span class="c1"># compute energy</span>
            <span class="n">rho_ab</span><span class="p">,</span> <span class="n">rho_ba</span> <span class="o">=</span> <span class="n">get_mps_2rdm</span><span class="p">(</span><span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">)</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">evaluate_energy_rdm</span><span class="p">(</span><span class="n">ham_ab</span><span class="p">,</span> <span class="n">ham_ba</span><span class="p">,</span> <span class="n">rho_ab</span><span class="p">,</span> <span class="n">rho_ba</span><span class="p">)</span>
            <span class="c1">#e = evaluate_energy_mps(ham_ab, ham_ba, s_ab, s_ba, mps_a, mps_b)</span>
            <span class="n">e_tot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;k:&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;e:&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;k:&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">s_ab</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">s_ba</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">mps_a</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">mps_b</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">mu_ab</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">mu_ba</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">nu_ab</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">nu_ba</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># MPS time evolutions</span>
        <span class="n">s_ab</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span> <span class="o">=</span> <span class="n">apply_gate_on_mps</span><span class="p">(</span><span class="n">gate_ab</span><span class="p">,</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">,</span> <span class="n">chi</span><span class="p">)</span>
        <span class="n">s_ba</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">,</span> <span class="n">mps_a</span> <span class="o">=</span> <span class="n">apply_gate_on_mps</span><span class="p">(</span><span class="n">gate_ba</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">chi</span><span class="p">)</span>

    <span class="n">rho_ab</span><span class="p">,</span> <span class="n">rho_ba</span> <span class="o">=</span> <span class="n">get_mps_2rdm</span><span class="p">(</span><span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">,</span> <span class="n">rho_ab</span><span class="p">,</span> <span class="n">rho_ba</span><span class="p">,</span> <span class="n">e_tot</span></div>




<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">chi</span> <span class="o">=</span> <span class="mi">160</span>  <span class="c1"># bond dimension</span>
    <span class="n">d</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">wavefunction_analysis.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_performance_log</span>
    <span class="n">set_performance_log</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">wavefunction_analysis.spins</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_spins</span>
    <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span> <span class="o">=</span> <span class="n">get_spins</span><span class="p">(</span><span class="s1">&#39;xy&#39;</span><span class="p">,</span> <span class="n">j</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
    <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span> <span class="o">=</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span>
    <span class="n">ham_ab</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sx</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">sy</span><span class="p">,</span> <span class="n">sy</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ham_ba</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sx</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">sy</span><span class="p">,</span> <span class="n">sy</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">tau</span> <span class="o">=</span> <span class="mf">.1</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    exact energy is 1./pi</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># weights</span>
    <span class="n">s_ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span>
    <span class="n">s_ba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span>
    <span class="c1"># MPSs</span>
    <span class="n">mps_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">chi</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">chi</span><span class="p">)</span>
    <span class="n">mps_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">chi</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">chi</span><span class="p">)</span>

    <span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">,</span> <span class="n">rho_ab</span><span class="p">,</span> <span class="n">rho_ba</span><span class="p">,</span> <span class="n">e_tot</span> <span class="o">=</span> <span class="n">run_tebd</span><span class="p">(</span>
            <span class="n">ham_ab</span><span class="p">,</span> <span class="n">ham_ba</span><span class="p">,</span> <span class="n">mps_a</span><span class="p">,</span> <span class="n">mps_b</span><span class="p">,</span> <span class="n">s_ab</span><span class="p">,</span> <span class="n">s_ba</span><span class="p">)</span>
    <span class="n">print_matrix</span><span class="p">(</span><span class="s1">&#39;e:&#39;</span><span class="p">,</span> <span class="n">e_tot</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Zheng Pei.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>